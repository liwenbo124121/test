<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.osc.scan.server.business.dao.TaskDao">
    <resultMap id="taskResultMap" type="org.osc.scan.server.business.pojo.dto.TaskDto">
        <result column="task_id" property="taskId"/>
        <result column="task_name" property="taskName"/>
        <result column="module_id" property="moduleId"/>
        <result column="start_way" property="startWay"/>
        <result column="task_owner" property="taskOwner"/>
        <result column="status" property="status"/>
        <result column="err_desc" property="errDesc"/>
        <result column="scan_path" property="scanPath"/>
        <result column="scan_path_md5" property="scanPathMd5"/>
        <result column="filter_path" property="filterPath"/>
        <result column="filter_path_md5" property="filterPathMd5"/>
        <result column="type" property="type"/>
        <result column="is_baseline" property="isBaseline"/>
        <result column="bug_priority" property="bugPriority"/>
        <result column="reply" property="reply"/>
        <result column="branch_name" property="branchName"/>
        <result column="commit_id" property="commitId"/>
        <result column="base_commit_id" property="baseCommitId"/>
        <result column="commit_id_ref" property="commitIdRef"/>
        <result column="commit_time" property="commitTime"/>
        <result column="third_party_id" property="thirdPartyId"/>
        <result column="committer" property="committer"/>
        <result column="ordertime" property="ordertime"/>
        <result column="createtime" property="createtime"/>
        <result column="starttime" property="starttime"/>
        <result column="endtime" property="endtime"/>
        <result column="computehash_status" property="computehashStatus"/>
        <result column="computehash_msg" property="computehashMsg"/>
        <result column="access_id" property="accessId"/>
        <result column="third_party_type" property="thirdPartyType"/>
        <result column="rule_set_ids" property="ruleSetIds"/>
        <result column="rule_set_names" property="ruleSetNames"/>
        <result column="company" property="company"/>
        <result column="project" property="project"/>
        <result column="parser_name" property="parserName"/>
        <result column="is_cronjob" property="isCronjob"/>
    </resultMap>

    <!--主键查询-->
    <select id="find" resultMap="taskResultMap" parameterType="java.lang.Integer">
        select *
        from task t
        where t.task_id = #{taskId}
    </select>

    <!--查询子任务未全部成功合计-->
    <select id="unSuccTaskCount" resultType="java.lang.Integer" parameterType="java.lang.Integer">
        select count(*)
        from task t,
        subtask s
        where t.task_id = s.task_id
        and s.task_id = #{taskId}
        and s.scan_type_id = #{scanTypeId,jdbcType=INTEGER}
        and s.status != 3
    </select>

    <!--更新任务规则集-->
    <update id="updateTaskRules" parameterType="org.osc.scan.server.business.pojo.dto.TaskDto">
        update task t
        <set>
            t.rule_set_ids = #{ruleSetIds},
            t.rule_set_names = #{ruleSetNames}
        </set>
        <where>
            t.task_id = #{taskId}
        </where>
    </update>

    <!--根据task_id查询parse_node-->
    <select id="getParserNodeByTaskId" resultType="java.lang.String" parameterType="java.lang.Integer">
        select parser_name
        from task
        where task_id = #{taskId} limit 1
    </select>

    <update id="updateByPrimaryKeySelective">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update task
        <set>
            task_id = #{taskId},
            <if test="taskName != null">
                task_name = #{taskName},
            </if>
            <if test="moduleId != null">
                module_id = #{moduleId},
            </if>
            <if test="startWay != null">
                start_way = #{startWay},
            </if>
            <if test="taskOwner != null">
                task_owner = #{taskOwner},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="errDesc != null">
                err_desc = #{errDesc},
            </if>
            <if test="scanPath != null">
                scan_path = #{scanPath},
            </if>
            <if test="scanPathMd5 != null">
                scan_path_md5 = #{scanPathMd5},
            </if>
            <if test="filterPath != null">
                filter_path = #{filterPath},
            </if>
            <if test="filterPathMd5 != null">
                filter_path_md5 = #{filterPathMd5},
            </if>
            <if test="type != null">
                type = #{type},
            </if>
            <if test="isBaseline != null">
                is_baseline = #{isBaseline},
            </if>
            <if test="bugPriority != null">
                bug_priority = #{bugPriority},
            </if>
            <if test="reply != null">
                reply = #{reply},
            </if>
            <if test="branchName != null">
                branch_name = #{branchName},
            </if>
            <if test="commitId != null">
                commit_id = #{commitId},
            </if>
            <if test="baseCommitId != null">
                base_commit_id = #{baseCommitId},
            </if>
            <if test="commitIdRef != null">
                commit_id_ref = #{commitIdRef},
            </if>
            <if test="commitTime != null">
                commit_time = #{commitTime},
            </if>
            <if test="thirdPartyId != null">
                third_party_id = #{thirdPartyId},
            </if>
            <if test="committer != null">
                committer = #{committer},
            </if>
            <if test="ordertime != null">
                ordertime = #{ordertime},
            </if>
            <if test="createtime != null">
                createtime = #{createtime},
            </if>
            <if test="starttime != null">
                starttime = #{starttime},
            </if>
            <if test="endtime != null">
                endtime = #{endtime},
            </if>
            <if test="computehashStatus != null">
                computeHash_status = #{computehashStatus},
            </if>
            <if test="computehashMsg != null">
                computeHash_msg = #{computehashMsg},
            </if>
            <if test="accessId != null">
                access_id = #{accessId},
            </if>
            <if test="thirdPartyType != null">
                third_party_type = #{thirdPartyType},
            </if>
            <if test="ruleSetIds != null">
                rule_set_ids = #{ruleSetIds},
            </if>
            <if test="ruleSetNames != null">
                rule_set_names = #{ruleSetNames},
            </if>
            <if test="company != null">
                company = #{company},
            </if>
            <if test="project != null">
                project = #{project},
            </if>
            <if test="parserName != null">
                parser_name = #{parserName},
            </if>
            <if test="isCronjob != null">
                is_cronjob = #{isCronjob},
            </if>
        </set>
        where task_id = #{taskId}
    </update>
</mapper>